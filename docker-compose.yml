# ---------------------------------------------------------------
# 서대전여고 AI 플랫폼 (OCI 서버 배포용) - 성능 최적화 버전
# 변경사항: Gunicorn 워커(4개) 및 스레드(4개) 증설 -> 동시 접속 성능 향상
# ---------------------------------------------------------------
version: '3.8'

services:
  # 1. Flask 애플리케이션 (웹앱)
  web:
    build: .
    container_name: ai_platform_web
    restart: always
    # [성능 튜닝 핵심]
    # --workers 4: OCI Ampere A1 (4 OCPU) 성능을 활용하기 위해 워커 수 증가
    # --threads 4: AI 대기 시간(I/O Blocking) 동안 다른 요청을 처리하도록 스레드 추가
    # 총 동시 처리 가능 요청 수 = 4 workers * 4 threads = 16 requests
    command: gunicorn --bind 0.0.0.0:8080 --workers 4 --threads 8 --timeout 300 --access-logfile - --error-logfile - --certfile=origin.pem --keyfile=privkey.pem app:app
    ports:
      - "8081:8080"  # 외부(8081) -> 내부(8080) 연결
    env_file:
      - .env
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - FLASK_APP=app.py
    volumes:
      - ./static/uploads:/app/static/uploads
      # [수정] certs 디렉토리의 인증서 파일을 컨테이너 내부로 마운트 (보안 강화)
      - ./certs/origin.pem:/app/origin.pem:ro
      - ./certs/privkey.pem:/app/privkey.pem:ro
    depends_on:
      - db

  # 2. PostgreSQL 데이터베이스
  db:
    image: postgres:15
    container_name: ai_platform_db
    restart: always
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
      - POSTGRES_DB=${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data: