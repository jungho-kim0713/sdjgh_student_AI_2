###################################################

프로젝트 현황: 서대전여고 수업용 AI 플랫폼

PM: 🏗️ AI 플랫폼 빌더

최종 업데이트: 2026년 1월 24일 (Season 6.5: AI 화가 기능 정상화 & 이미지 생성 오류 수정)

###################################################

===================================================
1. 현재 인프라 및 최신 구현 현황
===================================================
[ 1.1 현재 인프라 구조 ]

서버: Oracle Cloud Infrastructure (OCI) VM (Always Free 등급 / Ampere A1)

성능 튜닝: Gunicorn Workers 4 / Threads 8 (동시 접속 처리량 4배 증설)

네트워크: Cloudflare Proxy (HTTPS 적용)

도메인: sdjgh-ai.kr (HostingKR)

서브도메인: student-ai.sdjgh-ai.kr (학생용 서비스 메인)

보안: Flexible SSL/TLS Mode (서버 인증서 없이 HTTPS 구현)

포트 포워딩: Cloudflare Origin Rules 사용 (443 -> 8081 자동 연결)

컨테이너: Docker + Docker Compose (App + DB 통합 관리)

백엔드: Flask (Python 3.12)

데이터베이스: PostgreSQL 15 (Docker 컨테이너: ai_platform_db)

파일 저장소: 서버 로컬 볼륨 마운트 (./static/uploads)

외부 접속 포트: 8081 (Docker 내부 8080 매핑)

[ 1.2 최신 구현 사항 (Season 5.5 - 완료) ]
A. 보이스 인코더 (STT) 고도화 - Season 5.5

데스크탑/모바일 호환성 강화: setRangeText 및 이벤트 트리거 최적화로 모든 기기에서 입력 오류 해결.

중복 입력 방지: isFinal 속성을 활용하여 확정된 문장만 깔끔하게 입력되도록 로직 개선.

실시간 피드백 UI: 입력창 상단에 '실시간 자막 오버레이'를 구현하여, 말하는 내용을 즉각적으로 확인 가능하도록 UX 혁신.

단축키 지원: Ctrl + M 단축키로 마우스 없이도 간편하게 음성 입력 제어 가능.

B. 스마트 복사 버튼 (Smart Copy Button) - Season 5.5

UX 개선: 메시지 박스에 마우스를 올렸을 때만(Hover) 나타나는 세련된 복사 아이콘 구현.

Sticky Position: 긴 메시지를 읽을 때 스크롤을 내려도 복사 버튼이 화면 상단에 '착!' 붙어서 따라오도록 position: sticky 적용.

위치 최적화: 사용자 메시지는 '좌측 상단', AI 메시지는 '우측 상단' 바깥쪽 여백에 배치하여 가독성 확보.

모바일 대응: 모바일 환경에서는 터치 접근성을 위해 항상 표시되도록 반응형 처리.

C. 멀티 LLM 도입 및 프롬프트 분리 (Season 3)

OpenAI(GPT), Anthropic(Claude), Google(Gemini) 3사 모델 연동 완료.

모델별/역할별 시스템 프롬프트를 prompts.py 파일로 분리하여 관리 효율성 증대.

D. 보안 강화 (세션 권한 제어) (Season 3.5)

타인의 채팅방 접근 시 '읽기 전용(Read-Only)' 모드로 자동 전환.

Backend: 본인 소유의 세션이 아닐 경우 메시지 전송 API(POST /chat) 요청 시 403 Forbidden 에러 반환.

Frontend: 타인 채팅방 목록에 '자물쇠(🔒)' 아이콘 표시 및 입력창 비활성화 처리.

E. UI/UX 및 모바일 최적화 (Season 3.5)

모바일 전용 로고: 모바일 접속 시 logo_small.jpg로 자동 교체 (CSS content 속성 활용).

상태 표시 간소화: 모바일에서 관리자용 상태 버튼 텍스트 제거 및 Dot(점) 형태로 변경.

파일 업로드 개선: 모든 파일 형식 허용 및 직관적인 UI 적용.

F. AI 화가 (Image Generation) - Season 4

엔진: Google Imagen 4.0 (REST API 직접 호출로 라이브러리 의존성 해결)

기능: 'AI 화가' 페르소나 선택 시, 사용자의 한글 요청을 고품질 영어 프롬프트로 변환 후 이미지 생성.

UI: 채팅창 내 이미지 미리보기 및 클릭 시 원본 보기 지원.

[ 1.3 현재 파일 및 폴더 구조 ]
├── routes/                    # 라우팅 모듈 (모듈화 완료)
│   ├── __init__.py
│   ├── admin.py              # 관리자 기능
│   ├── auth.py               # 로그인/회원가입
│   ├── chat.py               # 채팅 API
│   ├── files.py              # 파일 업로드/다운로드
│   └── status.py             # 상태 관리
├── services/                  # 서비스 계층
│   ├── __init__.py
│   ├── ai_service.py         # AI 모델 통합
│   └── file_service.py       # 파일 처리
├── static/
│   ├── css/
│   │   └── admin.css
│   ├── images/
│   │   ├── claude.png
│   │   ├── gemini.png
│   │   ├── gpt.png
│   │   ├── logo.png
│   │   └── logo_small.jpg
│   ├── js/
│   │   ├── modules/          # 모듈화된 JS
│   │   │   ├── provider.js
│   │   │   ├── sessions.js
│   │   │   ├── status_admin.js
│   │   │   └── persona_visibility.js
│   │   └── app_context.js
│   └── uploads/
│       └── files/
├── templates/
│   └── index.html
├── certs/                     # SSL 인증서 (서버 전용)
│   ├── origin.pem
│   └── privkey.pem
├── .dockerignore
├── .env
├── .gitignore
├── .python-version
├── ai_core.py                # AI 핵심 로직
├── app.py                    # Flask 앱 메인
├── check_version.py
├── docker-compose.yml
├── Dockerfile
├── extensions.py             # Flask 확장
├── models.py                 # 데이터베이스 모델
├── project_status.txt
├── prompts.py
├── requirements.txt
├── test_claude.py
├── test_gemini.py
└── test_gpt.py

===================================================
2. 프로젝트 히스토리 (History)
===================================================
[ 2.05 Season 6.5. AI 화가 (Imagen) 오류 수정 및 정상화 (완료) ]
기간: 2026.01.24
목표: 'AI 화가' 기능에서 이미지가 생성되지 않고 깨지는(0byte/620byte) 오류 해결.
주요 성과:

원인 규명: Google GenAI SDK가 이미지를 decode된 bytes 형태로 반환함에도, 코드에서 중복 base64 decode를 수행하여 데이터 손상 발생.

코드 수정: routes/chat.py에서 불필요한 base64.b64decode 제거.

검증 완료: Gemini 3.0 Pro Image 모델 등에서 정상적인 이미지 생성 확인 (verify_fix.py).

배포 완료: GitHub Push 및 OCI 서버 배포(Pull & Restart) 완료.

[ 2.0 Season 6. 코드 구조 개선 및 배포 자동화 (완료) ]
기간: 2026.01.22
목표: 유지보수성 향상 및 배포 프로세스 간소화.
주요 성과:

코드 모듈화: 단일 파일(app.py 979줄)을 routes/, services/, models.py로 분리하여 관리성 향상.

Git 기반 배포: rsync/scp 방식에서 Git으로 전환하여 버전 관리 및 배포 자동화 구현.

서버 데이터 보존: 기존 .env, certs, uploads 파일을 안전하게 백업 후 새 구조로 마이그레이션.

Docker 설정 개선: docker-compose.yml의 Windows 하드코딩 경로를 상대 경로로 수정.

[ 2.1 Season 5.5 UX 혁신: 음성 & 편의성 (완료) ]
기간: 2026.01 중순
목표: 사용자 경험(UX)의 디테일 완성 및 편의 기능 강화.
주요 성과:

실시간 자막 STT: 음성 인식 내용을 실시간 오버레이로 보여주는 직관적인 UI 구현.

스마트 복사 버튼: 스크롤을 따라다니는(Sticky) 복사 버튼으로 긴 글 복사 편의성 극대화.

데스크탑 최적화: 단축키(Ctrl+M) 및 입력 호환성(setRangeText) 완벽 지원.

[ 2.2 Season 5. 네트워크 혁신 및 음성 인터페이스 (완료) ]
기간: 2026.01 초
목표: 모바일 사용성 극대화 및 보안 접속 환경 구축.
주요 성과:

도메인(sdjgh-ai.kr) 구매 및 Cloudflare 연동.

HTTPS 적용으로 모바일 마이크 권한 문제 해결 및 보이스 인코더 구현.

Origin Rules를 통한 포트 번호(:8081) 은닉 성공.

[ 2.3 Season 4. 창작 도구 확장 (완료) ]
기간: 2026.01 초
목표: 텍스트를 넘어선 멀티모달(이미지) 창작 지원.
주요 성과:

Google Imagen 4.0 모델 연동.

라이브러리 버전 호환성 이슈를 REST API 직접 호출 방식으로 돌파.

'AI 화가' 전용 시스템 프롬프트 및 페르소나 설계.

[ 2.4 Season 3.5 보안 및 모바일 최적화 (완료) ]
기간: 2025.12 말
주요 성과:

타인 채팅방 '읽기 전용' 모드 및 접근 제어 강화.

모바일 전용 로고 및 반응형 UI 개선.

[ 2.5 Season 3. 멀티 LLM 확장 (완료) ]

기간: 2025.12 중순

목표: 단일 모델 의존성 탈피 및 상황별 최적 모델 사용 지원.

주요 성과:

3대 AI 연동: OpenAI(GPT-4o), Anthropic(Claude 3.5), Google(Gemini 2.0) API 통합.

아키텍처 개선: app.py 내 하드코딩된 프롬프트를 prompts.py로 분리하여 관리 효율성 증대.

관리자 기능: 각 역할(Role)별로 사용할 AI 모델과 토큰 수를 관리자 패널에서 개별 설정 가능하도록 구현.

UI 개선: 헤더에 공급사(Provider) 선택 드롭다운 메뉴 추가.

[ 2.6 Season 2. 오라클 클라우드(OCI) 이관 (완료) ]

기간: 2025.12 초

목표: 'Oracle Cloud Always Free' 등급의 VM으로 완전 이관하여 고정 비용 0원 달성.

주요 성과:

인프라 이관: GCP(유료) -> OCI(무료) 서버 이전 성공.

Docker 도입: 개발 환경과 배포 환경의 일치화 (Docker Compose).

데이터 복원: SQL 백업 파일을 이용해 기존 GCP의 대화 기록 완벽 복구.

[ 2.7 Season 1. GCP 기반 구축 및 배포 (완료) ]

기간: 초기 개발 ~ 2025.11

목표: 웹 기반 AI 채팅 플랫폼 MVP(최소 기능 제품) 구축.

주요 성과:

기획, 백엔드/프론트엔드 기초 구현, 로그인 시스템, 관리자 패널 개발.

PDF/Office 문서 분석 기능 및 이미지 업로드 기능 구현.

===================================================
3. 운영 및 유지보수 매뉴얼 (OCI 서버)
===================================================
[ 3.0 pc 터미널에서 가상 환경 ]
가상 환경 켜기, 끄기
.\venv\Scripts\Activate.ps1
deactivate

키 권한 오류 시(WARNING: UNPROTECTED...):
관리자 권한 PowerShell에서 권한 재설정 스크립트 실행 (icacls / reset).

[ 3.1 서버 접속 및 기본 정보 ]

접속 명령어 (PC 터미널):
ssh oracle-student-ai

폴더 이동:
cd ~/sdjgh_ai

프로젝트 폴더: ~/sdjgh_ai (/home/ubuntu/sdjgh_ai)
웹 접속 주소: http://152.67.193.142:8081
업로드 파일 위치: ~/sdjgh_ai/static/uploads

[ 3.2 Docker 명령어 (운영체제별 구분) ]
- 로컬(Windows): sudo 없이 사용 (PowerShell)
- 서버(Linux): sudo 필수 사용 (권한 문제 시)

A. 로컬 Windows (내 컴퓨터)
서버 켜기: docker-compose up -d
서버 재비(코드 반영): docker-compose up -d --build --force-recreate
서버 끄기: docker-compose down
로그 확인: docker-compose logs -f web

B. 서버 Linux (OCI 클라우드)
서버 켜기: sudo docker-compose up -d
서버 재비(코드 반영): sudo docker-compose up -d --build --force-recreate
서버 끄기: sudo docker-compose down
로그 확인: sudo docker-compose logs -f web

[ 3.3 서버 코드 배포 (Git 기반) ]
GitHub 저장소: https://github.com/jungho-kim0713/sdjgh_student_AI_2.git

로컬(Windows)과 서버(OCI) 모두 동일한 Git 저장소와 연결되어 버전 관리됨.

배포 프로세스 (3단계):

1. 로컬에서 변경사항 커밋 및 푸시:
   git add .
   git commit -m "커밋 메시지"
   git push origin main

2. 서버에서 최신 코드 받기:
   ssh oracle-student-ai
   cd ~/sdjgh_ai
   git pull origin main

3. Docker 서비스 재시작 (변경사항 반영):
   docker-compose restart
   # 또는 완전 재빌드 시: docker-compose up -d --build --force-recreate

원라이너 (로컬에서 푸시 후 서버 업데이트까지 한 번에):
   git push origin main && ssh oracle-student-ai "cd ~/sdjgh_ai && git pull origin main && docker-compose restart"

주의사항:
- .env, certs/, static/uploads/ 폴더는 .gitignore에 등록되어 Git으로 관리되지 않음 (보안)
- 서버의 중요 데이터는 ~/sdjgh_ai_backup/에 백업되어 있음

[ 3.4 환경 변수 및 보안 설정 (.env) ]

DB_HOST=db
DB_NAME=chatbot_db
DB_USER=postgres
DB_PASS=[실제 비밀번호]
ANTHROPIC_API_KEY=[실제 키]
OPENAI_API_KEY=[실제 키]
GOOGLE_API_KEY=[실제 키]
SECRET_KEY=[임의의 긴 문자열]
주의: API 키 변경 시 .env 수정 후 서버 재시작(--force-recreate) 필수.

===================================================
4. 핵심 파일 목록 및 향후 계획
===================================================
[ 4.1 핵심 파일 목록 (업로드 체크리스트) ]

app.py: 메인 백엔드 로직 (보안 패치 적용됨)
prompts.py: AI 페르소나 및 시스템 프롬프트 정의
static/script.js: 프론트엔드 로직 (읽기 전용 모드 등)
static/style.css: 스타일 시트 (모바일 로고 최적화)
templates/index.html: 메인 UI 템플릿
docker-compose.yml: 컨테이너 오케스트레이션 설정

.env: 환경 변수 (보안 주의, 로컬/서버 별도 관리)

[ 4.2 다음 단계 예정 사항 ]

추가 기능 고도화 및 사용자 피드백 반영 버그 수정.

데이터베이스 정기 백업 및 유지보수 루틴 확립.